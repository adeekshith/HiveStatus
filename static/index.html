<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gatus Monitoring</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@100;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- Replaced single grid with a groups container -->
        <div id="groups-container" class="groups-container">
            <!-- Groups will be injected here -->
        </div>
        <div id="last-updated" class="last-updated"></div>
    </div>

    <script>
        // Configuration
        const REFRESH_INTERVAL_MS = 60000; // 1 minute

        async function fetchData() {
            try {
                const response = await fetch('/api/statuses');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                render(data);
                updateLastUpdated();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function getGroupName(key) {
            if (!key) return "Ungrouped";
            if (key.startsWith('_')) {
                return "Ungrouped";
            }
            const parts = key.split('_');
            if (parts.length > 0 && parts[0]) {
                // Capitalize first letter
                return parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
            }
            return "Ungrouped";
        }

        function render(services) {
            const container = document.getElementById('groups-container');
            container.innerHTML = ''; // Clear existing content

            // Group services
            const groups = {};
            services.forEach(service => {
                const groupName = getGroupName(service.key || service.name); // Fallback to name if key missing
                if (!groups[groupName]) {
                    groups[groupName] = [];
                }
                groups[groupName].push(service);
            });

            // Sort group names (Ungrouped last, others alphabetical)
            const sortedGroupNames = Object.keys(groups).sort((a, b) => {
                if (a === 'Ungrouped') return 1;
                if (b === 'Ungrouped') return -1;
                return a.localeCompare(b);
            });

            sortedGroupNames.forEach(groupName => {
                const groupServices = groups[groupName];
                
                // Create Details Element
                const details = document.createElement('details');
                details.className = 'group-section';
                details.open = true; // Open by default

                // Create Summary
                const summary = document.createElement('summary');
                summary.textContent = groupName;
                details.appendChild(summary);

                // Create Grid Container for this group
                const ul = document.createElement('ul');
                ul.className = 'hexagon-grid-container';

                // Render Hexagons for this group
                groupServices.forEach(service => {
                    const result = service.results && service.results.length > 0 ? service.results[0] : null;
                    const isSuccess = result ? result.success : false;
                    const colorClass = isSuccess ? 'hexagon-green' : 'hexagon-red';
                    
                    const li = document.createElement('li');
                    li.className = `hexagon ${colorClass}`;
                    
                    const innerDiv = document.createElement('div');
                    innerDiv.className = 'hexagon-inner';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'hexagon-name';
                    nameSpan.textContent = service.name;
                    
                    innerDiv.appendChild(nameSpan);

                    if (result && result.hostname) {
                         const metricSpan = document.createElement('span');
                         metricSpan.className = 'hexagon-metric-label';
                         metricSpan.textContent = result.hostname;
                         innerDiv.appendChild(metricSpan);
                    }

                    li.appendChild(innerDiv);
                    ul.appendChild(li);
                });

                details.appendChild(ul);
                container.appendChild(details);
            });
        }

        function updateLastUpdated() {
            const el = document.getElementById('last-updated');
            const now = new Date();
            el.textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }

        // Fetch data on load
        fetchData();
        
        // Refresh periodically
        setInterval(fetchData, REFRESH_INTERVAL_MS);
    </script>
</body>
</html>
